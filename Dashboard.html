<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cloud Dashboard - AI Image Generator</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #2c3e50;
      min-height: 100vh;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; position: relative; }
    

    /* Header */
    header {
      padding: 18px 0;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0,0,0,0.06);
      position: sticky; top: 0; z-index: 60;
    }
    nav { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .logo { font-size: 26px; font-weight: 800; color:#2c3e50; text-decoration:none; letter-spacing: .6px; }
    .nav-buttons { display:flex; gap:12px; align-items:center; }
    .btn { padding:10px 18px; border-radius:10px; font-weight:600; border: none; cursor:pointer; font-size:14px; transition: all 0.3s ease; }
    .btn-outline { background:transparent; border:1px solid rgba(44,62,80,0.12); color:#2c3e50; }
    .btn-solid {
      background: linear-gradient(135deg,#2c3e50,#34495e);
      color: #fff;
      box-shadow: 0 8px 25px rgba(44,62,80,0.08);
    }
    .btn:hover { transform: translateY(-1px); }

    /* Credit Display */
    .credit-display {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
    }

    .credit-display.low-credits {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    .credit-display.no-credits {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
    }

    .credit-icon {
      width: 16px;
      height: 16px;
      background: currentColor;
      border-radius: 50%;
      display: inline-block;
    }

    /* Floating background elements */
    .floating-element {
      position: absolute;
      border-radius: 50%;
      background: linear-gradient(45deg, rgba(52,152,219,0.10), rgba(155,89,182,0.10));
      pointer-events: none;
      filter: blur(0.5px);
      animation: float 6s ease-in-out infinite;
      z-index: 1;
    }
    .floating-element.f1 { width: 80px; height:80px; top: 14%; left: 6%; animation-delay: 0s; }
    .floating-element.f2 { width: 60px; height:60px; top: 62%; right: 12%; animation-delay: 2s; }
    .floating-element.f3 { width: 120px; height:120px; bottom: 12%; left: 18%; animation-delay: 4s; }
    @keyframes float {
      0%,100% { transform: translateY(0) rotate(0deg); opacity: 0.75; }
      50% { transform: translateY(-18px) rotate(180deg); opacity: 1; }
    }

    /* Main Content */
    .main-content { 
      padding: 40px 0; 
      position: relative; 
      z-index: 10; 
    }

    .page-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .page-header h1 {
      font-size: clamp(28px, 4vw, 42px);
      font-weight: 800;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .page-header p {
      color: #6f7a83;
      font-size: 16px;
    }

    /* Credit Info Section */
    .credit-info {
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.05);
      backdrop-filter: blur(10px);
      border-left: 4px solid #27ae60;
    }

    .credit-info.no-credits {
      border-left-color: #e74c3c;
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.05), rgba(192, 57, 43, 0.05));
    }

    .credit-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .credit-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .credit-number {
      font-size: 24px;
      font-weight: 800;
      color: #2c3e50;
    }

    .credit-label {
      font-size: 12px;
      color: #6f7a83;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .reset-timer {
      font-size: 14px;
      color: #6f7a83;
      text-align: center;
      margin-top: 10px;
      display: none;
    }

    /* Generator Section */
    .generator-section {
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.07);
      backdrop-filter: blur(10px);
    }

    .generator-section.disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    /* API Configuration */
    .api-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      border-left: 4px solid #2c3e50;
    }

    .api-section h3 {
      margin-bottom: 15px;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 700;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #27ae60;
      transition: background 0.3s ease;
    }

    /* Form Elements */
    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    input[type="file"] {
      padding: 20px;
      border: 2px dashed #e1e5e9;
      background: #f8f9fa;
      cursor: pointer;
    }

    input[type="file"]:hover {
      border-color: #2c3e50;
      background: #ecf0f1;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #2c3e50;
      box-shadow: 0 0 0 3px rgba(44,62,80,0.1);
    }

    .image-preview {
      margin-top: 15px;
      display: none;
      text-align: center;
    }

    .image-preview img {
      max-width: 200px;
      max-height: 200px;
      border-radius: 10px;
      object-fit: cover;
      border: 2px solid #e1e5e9;
    }

    /* Advanced Options */
    .advanced-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    /* Generate Button */
    .generate-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
    }

    .generate-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(44,62,80,0.3);
    }

    .generate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #95a5a6;
    }

    /* Loading */
    .loading {
      display: none;
      text-align: center;
      margin: 30px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2c3e50;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Messages */
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid #e74c3c;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      border-left: 4px solid #27ae60;
    }

    /* No Credits Message */
    .no-credits-message {
      background: linear-gradient(135deg, #fff5f5, #fed7d7);
      border: 2px solid #feb2b2;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      margin: 20px 0;
    }

    .no-credits-message h3 {
      color: #e53e3e;
      font-size: 20px;
      margin-bottom: 10px;
    }

    .no-credits-message p {
      color: #744210;
      margin-bottom: 15px;
      line-height: 1.5;
    }

    /* Gallery */
    .result-section {
      margin-top: 40px;
    }

    .image-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .image-card {
      background: #ffffff;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 8px 25px rgba(0,0,0,0.06);
      transition: transform .3s, box-shadow .3s;
      max-width: 350px;
      margin: 0 auto;
    }

    .image-card:hover {
      transform: translateY(-5px) scale(1.01);
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }

    .image-card img {
      width: 100%;
      height: 250px;
      object-fit: cover;
      display: block;
    }

    .image-info {
      padding: 16px 18px;
    }

    .image-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .download-btn {
      background: #27ae60;
      color: white;
    }

    .download-btn:hover {
      background: #229954;
      transform: translateY(-1px);
    }
    
    .delete-btn {
      background: #e74c3c;
      color: white;
    }

    .delete-btn:hover {
      background: #c0392b;
      transform: translateY(-1px);
    }
    
    /* Storage Controls */
    .storage-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px 0;
      border-bottom: 1px solid #e1e5e9;
    }
    
    .storage-controls h3 {
      color: #2c3e50;
      font-size: 20px;
      font-weight: 700;
    }
    
    .storage-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .storage-info span {
      color: #6f7a83;
      font-size: 14px;
    }
    
    /* Image metadata */
    .image-meta {
      font-size: 11px;
      color: #95a5a6;
      margin-bottom: 8px;
      font-style: italic;
    }
    
    /* Visual distinction for stored vs new images */
    .new-image {
      border: 2px solid #27ae60;
      position: relative;
    }
    
    .new-image::before {
      content: 'NEW';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #27ae60;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      z-index: 2;
    }
    
    .stored-image {
      opacity: 0.9;
    }
    
    /* Image Modal Styles */
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      cursor: pointer;
    }
    
    .image-modal-content {
      position: relative;
      width: 90%;
      max-width: 800px;
      margin: 2% auto;
      background: #fff;
      border-radius: 20px;
      overflow: hidden;
      cursor: default;
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 35px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      z-index: 1001;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .close-modal:hover {
      background: rgba(0, 0, 0, 0.8);
      transform: scale(1.1);
    }
    
    .image-modal img {
      width: 100%;
      max-height: 70vh;
      object-fit: contain;
      display: block;
    }
    
    .modal-info {
      padding: 20px;
      background: #fff;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
    }
    
    .modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    /* Mobile responsive for modal */
    @media (max-width: 768px) {
      .image-modal-content {
        width: 95%;
        margin: 5% auto;
      }
      
      .image-modal img {
        max-height: 60vh;
      }
      
      .close-modal {
        top: 10px;
        right: 10px;
        font-size: 30px;
        width: 40px;
        height: 40px;
      }
      
      .modal-info {
        padding: 15px;
      }
    }

    /* Footer */
    footer {
      margin-top: 60px;
      background: rgba(44,62,80,0.04);
      padding: 28px 0;
      text-align: center;
      color: #4a5561;
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 0 15px;
      }
      
      .generator-section {
        padding: 20px;
        margin: 10px 0;
      }
      
      .advanced-options {
        grid-template-columns: 1fr;
      }
      
      .image-gallery {
        grid-template-columns: 1fr;
        max-width: 100%;
        gap: 15px;
      }
      
      .image-card {
        max-width: 100%;
      }
      
      .image-card img {
        height: 200px;
      }
      
      .storage-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .storage-info {
        align-self: stretch;
        justify-content: space-between;
      }

      .credit-stats {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Floating elements -->
  <div class="floating-element f1"></div>
  <div class="floating-element f2"></div>
  <div class="floating-element f3"></div>

  <!-- Header -->
  <header>
    <div class="container">
      <nav>
        <a class="logo" href="index.html">cloud</a>
        <div class="nav-buttons">
          <div class="credit-display" id="creditDisplay">
            <span class="credit-icon"></span>
            <span id="creditText">10 Credits</span>
          </div>
          <button class="btn btn-outline" onclick="window.location.href='index.html'">Back to Home</button>
          <button class="btn btn-solid">Account</button>
        </div>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h1>Paper Art Transformer</h1>
        <p>Transform your photos into expressive paper art style</p>
      </div>

      <!-- Credit Information -->
      <div class="credit-info" id="creditInfo">
        <div class="credit-stats">
          <div class="credit-item">
            <div class="credit-number" id="creditsRemaining">10</div>
            <div class="credit-label">Credits Remaining</div>
          </div>
          <div class="credit-item">
            <div class="credit-number" id="creditsUsed">0</div>
            <div class="credit-label">Used Today</div>
          </div>
          <div class="credit-item">
            <div class="credit-number">10</div>
            <div class="credit-label">Daily Limit</div>
          </div>
        </div>
      </div>

      <div class="no-credits-message" id="noCreditsMessage" style="display: none;">
        <h3>🎨 You've used all your daily credits!</h3>
        <p>You've generated <strong>10 amazing artworks</strong> today.</p>
        <p style="margin-top: 15px; font-size: 14px;">Come back tomorrow for 10 fresh credits to create more paper art masterpieces!</p>
      </div>

      <div class="generator-section" id="generatorSection">
        <div class="api-section">
          <h3>
            <span class="status-indicator"></span>
            Paper Art Generator
          </h3>
          <p style="color: #6f7a83; font-size: 14px; margin-bottom: 20px;">Upload an image to transform it into expressive paper art with vibrant colors and abstract elements</p>
        </div>

        <div class="input-group">
          <label for="imageUpload">Upload Your Image:</label>
          <input type="file" id="imageUpload" accept="image/*" />
          <div id="imagePreview" class="image-preview">
            <img id="previewImg" alt="Image preview">
          </div>
        </div>

        <div class="advanced-options">
          <div class="input-group">
            <label for="artStyle">Art Style:</label>
            <select id="artStyle">
              <option value="paper" selected>Paper Art Style</option>
            </select>
          </div>

          <div class="input-group">
            <label for="styleIntensity">Style Intensity:</label>
            <select id="styleIntensity">
              <option value="subtle">Subtle</option>
              <option value="moderate" selected>Moderate</option>
              <option value="strong">Strong</option>
              <option value="extreme">Extreme</option>
            </select>
          </div>

          <div class="input-group">
            <label for="aspectRatio">Device & Aspect Ratio:</label>
            <select id="aspectRatio">
              <!-- Mobile Devices -->
              <option value="9:16">Mobile Portrait (9:16) - 1080x1920</option>
              <option value="16:9">Mobile Landscape (16:9) - 1920x1080</option>
              <option value="9:18">Mobile Long (9:18) - 1080x2160</option>
              
              <!-- Tablets -->
              <option value="3:4">Tablet Portrait (3:4) - 1536x2048</option>
              <option value="4:3">Tablet Landscape (4:3) - 2048x1536</option>
              
              <!-- Desktop/Laptop -->
              <option value="16:10">Desktop (16:10) - 1920x1200</option>
              <option value="21:9">Ultrawide (21:9) - 2560x1080</option>
              <option value="1:1" selected>Square (1:1) - 1024x1024</option>
              
              <!-- 4K Resolutions -->
              <option value="16:9-4k">4K Desktop (16:9) - 3840x2160</option>
              <option value="21:9-4k">4K Ultrawide (21:9) - 5120x2160</option>
              <option value="9:16-4k">4K Mobile (9:16) - 2160x3840</option>
              
              <!-- Watch & Small Devices -->
              <option value="1:1-watch">Watch Square - 312x312</option>
              <option value="watch-round">Watch Round (1:1) - 360x360</option>
              
              <!-- Social Media -->
              <option value="instagram">Instagram Square - 1080x1080</option>
              <option value="instagram-story">Instagram Story - 1080x1920</option>
              <option value="youtube-thumb">YouTube Thumbnail - 1280x720</option>
            </select>
          </div>
        </div>

        <button class="generate-btn" onclick="generateImages()" id="generateBtn">
          Transform to Paper Art (1 Credit)
        </button>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p id="loadingText">Analyzing your image and transforming to paper art...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <div id="messageContainer"></div>
      </div>

      <div class="result-section">
        <div class="storage-controls">
          <h3>Generated Images</h3>
          <div class="storage-info">
            <span id="storageCount">0 images stored locally</span>
            <button class="btn btn-outline" onclick="clearAllStoredImages()" id="clearStorageBtn">
              Clear All Images
            </button>
          </div>
        </div>
        <div class="image-gallery" id="imageGallery"></div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container">
      © <strong>Cloud</strong> — Beautiful experiences in the cloud. All rights reserved.
    </div>
  </footer>

  <!-- Image Popup Modal -->
  <div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <div class="image-modal-content">
      <span class="close-modal" onclick="closeImageModal()">&times;</span>
      <img id="modalImage" src="" alt="Full size image">
      <div class="modal-info">
        <div class="modal-actions">
          <button id="modalDownload" class="modal-btn download-btn" onclick="downloadModalImage()">
            Download
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Backend API Configuration
    const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : '/api';
    
    // Remove exposed API key
    // const GEMINI_API_KEY = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
    // const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';
    
    let uploadedImageData = null;
    let uploadedImageBase64 = null;
    let generatedImages = [];

    // Local Storage Configuration
    const STORAGE_KEY = 'paperArtGeneratedImages';
    const MAX_STORED_IMAGES = 50; // Limit to prevent storage overflow

    // Credit System Configuration
    const DAILY_CREDIT_LIMIT = 10;
    const CREDIT_COST_PER_IMAGE = 1;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      setupImageUpload();
      initializeCreditSystem();
      updateCreditDisplay();
      loadStoredImages(); // Load previously generated images
      setupModalEventListeners(); // Setup modal event listeners
    });
    
    function setupModalEventListeners() {
      const modal = document.getElementById('imageModal');
      
      // Close modal when clicking outside the image
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeImageModal();
        }
      });
      
      // Close modal with Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'block') {
          closeImageModal();
        }
      });
    }

    // Local Storage Functions
    function saveImageToStorage(imageData) {
      try {
        const storedImages = getStoredImages();
        
        // Add timestamp and unique ID
        const imageWithMetadata = {
          ...imageData,
          id: Date.now() + Math.random().toString(36).substr(2, 9),
          savedAt: new Date().toISOString(),
          localImage: null // Will store base64 data
        };
        
        // Convert image URL to base64 for local storage
        convertImageToBase64(imageData.url).then(base64Data => {
          imageWithMetadata.localImage = base64Data;
          
          // Add to beginning of array (newest first)
          storedImages.unshift(imageWithMetadata);
          
          // Limit storage size
          if (storedImages.length > MAX_STORED_IMAGES) {
            storedImages.splice(MAX_STORED_IMAGES);
          }
          
          localStorage.setItem(STORAGE_KEY, JSON.stringify(storedImages));
          console.log('Image saved to local storage');
          updateStorageCount();
        }).catch(error => {
          console.error('Failed to save image to storage:', error);
          // Save without base64 data as fallback
          storedImages.unshift(imageWithMetadata);
          if (storedImages.length > MAX_STORED_IMAGES) {
            storedImages.splice(MAX_STORED_IMAGES);
          }
          localStorage.setItem(STORAGE_KEY, JSON.stringify(storedImages));
        });
        
      } catch (error) {
        console.error('Error saving to localStorage:', error);
      }
    }
    
    function getStoredImages() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
      } catch (error) {
        console.error('Error reading from localStorage:', error);
        return [];
      }
    }
    
    function convertImageToBase64(imageUrl) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          canvas.width = img.width;
          canvas.height = img.height;
          
          ctx.drawImage(img, 0, 0);
          
          try {
            const base64Data = canvas.toDataURL('image/png');
            resolve(base64Data);
          } catch (error) {
            reject(error);
          }
        };
        
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = imageUrl;
      });
    }
    
    function loadStoredImages() {
      const storedImages = getStoredImages();
      if (storedImages.length > 0) {
        console.log(`Loading ${storedImages.length} stored images`);
        displayStoredImages(storedImages);
      }
      updateStorageCount();
    }
    
    function updateStorageCount() {
      const storedImages = getStoredImages();
      const count = storedImages.length;
      const storageCountElement = document.getElementById('storageCount');
      const clearBtn = document.getElementById('clearStorageBtn');
      
      if (storageCountElement) {
        storageCountElement.textContent = `${count} image${count !== 1 ? 's' : ''} stored locally`;
      }
      
      if (clearBtn) {
        clearBtn.style.display = count > 0 ? 'block' : 'none';
      }
    }
    
    function displayStoredImages(images) {
      const gallery = document.getElementById('imageGallery');
      
      images.forEach((image, index) => {
        const imageCard = document.createElement('div');
        imageCard.className = 'image-card stored-image';
        
        // Use local base64 data if available, otherwise use original URL
        const imgSrc = image.localImage || image.url;
        const savedDate = new Date(image.savedAt).toLocaleDateString();
        
        imageCard.innerHTML = `
          <img src="${imgSrc}" alt="Paper art transformation" loading="lazy" onclick="openImageModal('${imgSrc}', '', 'stored', '${image.id}')" style="cursor: pointer;" onerror="this.src='${image.url}'">
          <div class="image-info">
            <div class="image-meta">Saved: ${savedDate}</div>
            <div class="image-actions">
              <button class="action-btn download-btn" onclick="downloadStoredImage('${image.id}', ${index})">
                Download
              </button>
              <button class="action-btn delete-btn" onclick="deleteStoredImage('${image.id}')">
                Delete
              </button>
            </div>
          </div>
        `;
        gallery.appendChild(imageCard);
      });
    }
    
    function clearAllStoredImages() {
      if (confirm('Are you sure you want to delete all stored images? This cannot be undone.')) {
        localStorage.removeItem(STORAGE_KEY);
        const gallery = document.getElementById('imageGallery');
        gallery.innerHTML = '';
        updateStorageCount();
        showMessage('All stored images have been deleted', 'success');
      }
    }
    
    function deleteStoredImage(imageId) {
      if (confirm('Are you sure you want to delete this image?')) {
        const storedImages = getStoredImages();
        const updatedImages = storedImages.filter(img => img.id !== imageId);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(updatedImages));
        
        // Remove from DOM
        const gallery = document.getElementById('imageGallery');
        gallery.innerHTML = '';
        
        // Reload stored images
        loadStoredImages();
        
        showMessage('Image deleted successfully', 'success');
      }
    }
    
    // Image Modal Functions
    let currentModalImage = null;
    
    function openImageModal(imageSrc, prompt, type, imageId = null) {
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      
      modalImage.src = imageSrc;
      modal.style.display = 'block';
      
      // Store current image data for download
      currentModalImage = {
        src: imageSrc,
        type: type,
        id: imageId
      };
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = 'hidden';
    }
    
    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.style.display = 'none';
      currentModalImage = null;
      
      // Re-enable body scroll
      document.body.style.overflow = 'auto';
    }
    
    function downloadModalImage() {
      if (!currentModalImage) return;
      
      if (currentModalImage.type === 'stored' && currentModalImage.id) {
        downloadStoredImage(currentModalImage.id, 0);
      } else {
        downloadImage(currentModalImage.src, 0);
      }
    }

    // Credit System Functions
    function initializeCreditSystem() {
      const today = new Date().toDateString();
      const storedData = JSON.parse(localStorage.getItem('paperArtCredits') || '{}');
      
      // Reset credits if it's a new day
      if (storedData.date !== today) {
        const newData = {
          date: today,
          creditsUsed: 0,
          creditsRemaining: DAILY_CREDIT_LIMIT
        };
        localStorage.setItem('paperArtCredits', JSON.stringify(newData));
      }
    }

    function getCreditData() {
      return JSON.parse(localStorage.getItem('paperArtCredits') || '{}');
    }

    function updateCreditData(creditsUsed) {
      const today = new Date().toDateString();
      const data = {
        date: today,
        creditsUsed: creditsUsed,
        creditsRemaining: DAILY_CREDIT_LIMIT - creditsUsed
      };
      localStorage.setItem('paperArtCredits', JSON.stringify(data));
    }

    function hasCreditsRemaining() {
      const data = getCreditData();
      return data.creditsRemaining > 0;
    }

    function deductCredit() {
      const data = getCreditData();
      const newCreditsUsed = data.creditsUsed + CREDIT_COST_PER_IMAGE;
      updateCreditData(newCreditsUsed);
      updateCreditDisplay();
    }

    function updateCreditDisplay() {
      const data = getCreditData();
      const creditsRemaining = data.creditsRemaining || DAILY_CREDIT_LIMIT;
      const creditsUsed = data.creditsUsed || 0;

      // Update header credit display
      const creditDisplay = document.getElementById('creditDisplay');
      const creditText = document.getElementById('creditText');
      
      creditText.textContent = `${creditsRemaining} Credits`;
      
      // Update styling based on credit level
      creditDisplay.className = 'credit-display';
      if (creditsRemaining === 0) {
        creditDisplay.classList.add('no-credits');
      } else if (creditsRemaining <= 3) {
        creditDisplay.classList.add('low-credits');
      }

      // Update credit info section
      document.getElementById('creditsRemaining').textContent = creditsRemaining;
      document.getElementById('creditsUsed').textContent = creditsUsed;

      // Update credit info styling
      const creditInfo = document.getElementById('creditInfo');
      creditInfo.className = 'credit-info';
      if (creditsRemaining === 0) {
        creditInfo.classList.add('no-credits');
      }

      // Show/hide no credits message and disable/enable generator
      const noCreditsMessage = document.getElementById('noCreditsMessage');
      const generatorSection = document.getElementById('generatorSection');
      const generateBtn = document.getElementById('generateBtn');

      if (creditsRemaining === 0) {
        noCreditsMessage.style.display = 'block';
        generatorSection.classList.add('disabled');
        generateBtn.disabled = true;
        generateBtn.textContent = 'No Credits Remaining';
      } else {
        noCreditsMessage.style.display = 'none';
        generatorSection.classList.remove('disabled');
        generateBtn.disabled = false;
        generateBtn.textContent = `Transform to Paper Art (${CREDIT_COST_PER_IMAGE} Credit)`;
      }
    }

    function setupImageUpload() {
      const imageUpload = document.getElementById('imageUpload');
      const imagePreview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');
      
      imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            uploadedImageData = e.target.result;
            uploadedImageBase64 = e.target.result.split(',')[1]; // Remove data URL prefix
            previewImg.src = e.target.result;
            imagePreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });

      // Drag and drop functionality
      imageUpload.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.style.borderColor = '#2c3e50';
        this.style.backgroundColor = '#ecf0f1';
      });

      imageUpload.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.style.borderColor = '#e1e5e9';
        this.style.backgroundColor = '#f8f9fa';
      });

      imageUpload.addEventListener('drop', function(e) {
        e.preventDefault();
        this.style.borderColor = '#e1e5e9';
        this.style.backgroundColor = '#f8f9fa';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          this.files = files;
          const event = new Event('change', { bubbles: true });
          this.dispatchEvent(event);
        }
      });
    }

    async function generateImages() {
      // Check credits before proceeding
      if (!hasCreditsRemaining()) {
        showMessage("You've used all your daily credits. Come back tomorrow for more!", 'error');
        return;
      }

      if (!uploadedImageData || !uploadedImageBase64) {
        showMessage('Please upload an image first', 'error');
        return;
      }

      setLoading(true);
      clearMessages();

      try {
        const artStyle = document.getElementById('artStyle').value;
        const styleIntensity = document.getElementById('styleIntensity').value;
        const aspectRatio = document.getElementById('aspectRatio').value;
        
        const images = [];
        
        // Step 1: Analyze image using backend API
        updateProgress(20);
        const formData = new FormData();
        
        // Convert base64 back to blob for upload
        const blob = await fetch(`data:${uploadedImageData.split(';')[0].split(':')[1]};base64,${uploadedImageBase64}`).then(r => r.blob());
        formData.append('image', blob);
        formData.append('artStyle', artStyle);
        formData.append('styleIntensity', styleIntensity);
        
        const analysisResponse = await fetch(`${API_BASE_URL}/analyze-image`, {
          method: 'POST',
          body: formData
        });
        
        if (!analysisResponse.ok) {
          const errorData = await analysisResponse.json();
          throw new Error(errorData.error || 'Failed to analyze image');
        }
        
        const analysisData = await analysisResponse.json();
        updateProgress(60);
        
        // Step 2: Generate styled image using backend API
        const generationResponse = await fetch(`${API_BASE_URL}/generate-image`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            prompt: analysisData.description,
            aspectRatio: aspectRatio
          })
        });
        
        if (!generationResponse.ok) {
          const errorData = await generationResponse.json();
          throw new Error(errorData.error || 'Failed to generate image');
        }
        
        const generationData = await generationResponse.json();
        updateProgress(100);
        
        images.push({
          url: generationData.imageUrl,
          prompt: generationData.prompt,
          timestamp: new Date().toISOString()
        });
        
        if (images.length > 0) {
          // Deduct credit only after successful generation
          deductCredit();
          displayImages(images);
          showMessage('Successfully generated paper art transformation!', 'success');
        } else {
          showMessage('Failed to generate image', 'error');
        }

      } catch (error) {
        console.error('Generation failed:', error);
        showMessage(`Error: ${error.message}`, 'error');
      } finally {
        setLoading(false);
      }
    }

    // Remove old API functions since we're using backend now
    // async function analyzeAndDescribeImage() { ... }
    // async function generateStyledImage() { ... }

    function displayImages(images) {
      const gallery = document.getElementById('imageGallery');
      
      images.forEach((image, index) => {
        const imageCard = document.createElement('div');
        imageCard.className = 'image-card new-image';
        imageCard.innerHTML = `
          <img src="${image.url}" alt="Paper art transformation" loading="lazy" onclick="openImageModal('${image.url}', '', 'new')" style="cursor: pointer;">
          <div class="image-info">
            <div class="image-meta">Just generated</div>
            <div class="image-actions">
              <button class="action-btn download-btn" onclick="downloadImage('${image.url}', ${index})">
                Download
              </button>
            </div>
          </div>
        `;
        gallery.insertBefore(imageCard, gallery.firstChild); // Add new images at the top
        
        // Save to local storage
        saveImageToStorage(image);
        
        // Update storage count after saving
        setTimeout(() => updateStorageCount(), 100);
      });

      generatedImages.push(...images);
    }

    async function downloadImage(url, index) {
      try {
        showMessage('Downloading image...', 'success');
        
        // Create a proxy request through our backend to avoid CORS issues
        const response = await fetch(url, {
          method: 'GET',
          mode: 'cors'
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch image');
        }
        
        const blob = await response.blob();
        const downloadUrl = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `cloud-art-${Date.now()}.png`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(downloadUrl);
        }, 100);
        
        showMessage('Image downloaded successfully!', 'success');
      } catch (error) {
        console.error('Download error:', error);
        // Fallback: open image in new tab
        window.open(url, '_blank');
        showMessage('Download failed. Image opened in new tab instead.', 'error');
      }
    }
    
    async function downloadStoredImage(imageId, index) {
      try {
        showMessage('Downloading stored image...', 'success');
        
        const storedImages = getStoredImages();
        const image = storedImages.find(img => img.id === imageId);
        
        if (!image) {
          showMessage('Image not found', 'error');
          return;
        }
        
        let blob;
        
        if (image.localImage && image.localImage.startsWith('data:')) {
          // Convert base64 to blob
          const response = await fetch(image.localImage);
          blob = await response.blob();
        } else {
          // Fallback to original URL
          const response = await fetch(image.url, {
            method: 'GET',
            mode: 'cors'
          });
          
          if (!response.ok) {
            throw new Error('Failed to fetch image');
          }
          
          blob = await response.blob();
        }
        
        const downloadUrl = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `cloud-art-${Date.now()}.png`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(downloadUrl);
        }, 100);
        
        showMessage('Stored image downloaded successfully!', 'success');
      } catch (error) {
        console.error('Download error:', error);
        // Fallback: open image in new tab
        const storedImages = getStoredImages();
        const image = storedImages.find(img => img.id === imageId);
        if (image) {
          window.open(image.url, '_blank');
          showMessage('Download failed. Image opened in new tab instead.', 'error');
        }
      }
    }

    function openImageInNewTab(url) {
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    function setLoading(loading) {
      const loadingDiv = document.getElementById('loading');
      const generateBtn = document.getElementById('generateBtn');
      
      if (loading) {
        loadingDiv.style.display = 'block';
        generateBtn.disabled = true;
        generateBtn.textContent = 'Transforming...';
      } else {
        loadingDiv.style.display = 'none';
        // Only re-enable if credits are available
        if (hasCreditsRemaining()) {
          generateBtn.disabled = false;
          generateBtn.textContent = `Transform to Paper Art (${CREDIT_COST_PER_IMAGE} Credit)`;
        } else {
          generateBtn.disabled = true;
          generateBtn.textContent = 'No Credits Remaining';
        }
        updateProgress(0);
      }
    }

    function updateProgress(percent) {
      const progressFill = document.getElementById('progressFill');
      progressFill.style.width = percent + '%';
      
      const loadingText = document.getElementById('loadingText');
      if (percent < 40) {
        loadingText.textContent = 'Analyzing your image with Gemini AI...';
      } else if (percent < 80) {
        loadingText.textContent = 'Generating paper art transformation...';
      } else {
        loadingText.textContent = 'Finalizing your artwork...';
      }
    }

    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.textContent = message;
      container.appendChild(messageDiv);
      
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 5000);
    }

    function clearMessages() {
      document.getElementById('messageContainer').innerHTML = '';
      document.getElementById('imageGallery').innerHTML = '';
    }
  </script>
</body>
</html>

